name: NFTopia Main CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Job 1: Backend Services (Nest.js, Spring Boot, Django, Laravel, Express.js)
  backend-services:
    name: Test Backend Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['nftopia-backend', 'nftopia-payment-service', 'nftopia_analytics', 'nftopia-marketplace-service', 'nftopia-notification-service']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js (for Node services)
      if: matrix.service == 'nftopia-backend' || matrix.service == 'nftopia-notification-service'
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ${{ matrix.service }}/package-lock.json
    
    - name: Setup Java (Spring Boot)
      if: matrix.service == 'nftopia-payment-service'
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Python (Django)
      if: matrix.service == 'nftopia_analytics'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Setup PHP (Laravel)
      if: matrix.service == 'nftopia-marketplace-service'
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
        coverage: none
    
    - name: Install Dependencies
      run: |
        cd ${{ matrix.service }}
        if [ -f "package.json" ]; then
          npm ci
        elif [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        elif [ -f "composer.json" ]; then
          composer install --no-progress --prefer-dist
        elif [ -f "pom.xml" ]; then
          # Spring Boot - dependencies will be resolved during test
          echo "Java project detected"
        fi
    
    - name: Run Tests
      run: |
        cd ${{ matrix.service }}
        if [ -f "package.json" ]; then
          npm test
        elif [ -f "pytest.ini" ] || [ -f "manage.py" ]; then
          python -m pytest
        elif [ -f "phpunit.xml" ]; then
          ./vendor/bin/phpunit
        elif [ -f "pom.xml" ]; then
          mvn test
        fi

  # Job 2: Frontend Services (Next.js, React Native)
  frontend-services:
    name: Test Frontend Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['nftopia-frontend', 'nftopia-mobile-app']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ${{ matrix.service }}/package-lock.json
    
    - name: Install Dependencies
      run: |
        cd ${{ matrix.service }}
        npm ci
    
    - name: TypeScript Type Check
      run: |
        cd ${{ matrix.service }}
        npx tsc --noEmit
    
    - name: Run Tests
      if: matrix.service == 'nftopia-frontend'
      run: |
        cd ${{ matrix.service }}
        npm run test -- --passWithNoTests
    
    - name: Build Application
      run: |
        cd ${{ matrix.service }}
        if [ -f "next.config.js" ]; then
          npm run build
        elif [ -f "metro.config.js" ]; then
          # React Native - check build configuration
          echo "React Native project detected - skipping build on CI"
        fi

  # Job 3: Blockchain Services (StarkNet, Stellar/Soroban)
  blockchain-services:
    name: Test Blockchain Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['nftopia-starknet', 'nftopia-stellar']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Cairo/StarkNet
      if: matrix.service == 'nftopia-starknet'
      run: |
        curl -L https://raw.githubusercontent.com/software-mansion/protostar/master/install.sh | bash -s -- -v 0.10.3
        echo "$HOME/.protostar/dist/protostar" >> $GITHUB_PATH
    
    - name: Setup Rust (for Soroban)
      if: matrix.service == 'nftopia-stellar'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: wasm32-unknown-unknown
        profile: minimal
        override: true
    
    - name: Test StarkNet Contracts
      if: matrix.service == 'nftopia-starknet'
      run: |
        cd ${{ matrix.service }}
        protostar test
    
    - name: Test Soroban Contracts
      if: matrix.service == 'nftopia-stellar'
      run: |
        cd ${{ matrix.service }}
        cargo test --locked

  # Job 4: Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Snyk Security Scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --all-projects
    
    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # Job 5: Code Quality
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
    
    - name: Install ESLint globally
      run: npm install -g eslint
    
    - name: Run ESLint on TypeScript Projects
      run: |
        for dir in nftopia-*/; do
          if [ -f "$dir/package.json" ] && [ -d "$dir/src" ]; then
            echo "Running ESLint on $dir"
            cd "$dir"
            npx eslint "src/**/*.ts" "src/**/*.tsx" || echo "ESLint failed or not configured for $dir"
            cd ..
          fi
        done
    
    - name: Run Prettier Check
      run: |
        for dir in nftopia-*/; do
          if [ -f "$dir/package.json" ]; then
            echo "Checking formatting in $dir"
            cd "$dir"
            npx prettier --check "**/*.{ts,tsx,js,jsx,json,md}" || echo "Prettier not configured for $dir"
            cd ..
          fi
        done